static long qxl_fence_wait(struct dma_fence *fence, bool intr,
			   signed long timeout)
{
	struct qxl_device *qdev;
	unsigned long cur, end = jiffies + timeout;

	qdev = container_of(fence->lock, struct qxl_device, release_lock);

	if (!wait_event_timeout(qdev->release_event,
				(dma_fence_is_signaled(fence) ||
				 (qxl_io_notify_oom(qdev), 0)),
				timeout))
		return 0;

	cur = jiffies;
	if (time_after(cur, end))
		return 0;
	return end - cur;
}
