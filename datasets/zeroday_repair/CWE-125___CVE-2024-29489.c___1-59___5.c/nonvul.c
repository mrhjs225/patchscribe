static ecma_value_t JERRY_ATTR_NOINLINE
ecma_op_function_call_constructor (vm_frame_ctx_shared_args_t *shared_args_p, /**< shared data */
                                   ecma_object_t *scope_p, /**< lexical environment to use */
                                   ecma_value_t this_binding) /**< value of 'ThisBinding' */
{
  ECMA_CHECK_STACK_USAGE ();

  shared_args_p->header.status_flags |= VM_FRAME_CTX_SHARED_NON_ARROW_FUNC;

  ecma_value_t ret_value;

  if (JERRY_CONTEXT (current_new_target_p) == NULL)
  {
    ret_value = ecma_raise_type_error (ECMA_ERR_CLASS_CONSTRUCTOR_REQUIRES_NEW);
    goto exit;
  }

  ecma_extended_object_t *ext_func_p = (ecma_extended_object_t *) shared_args_p->header.function_object_p;
  if (ECMA_GET_THIRD_BIT_FROM_POINTER_TAG (ext_func_p->u.function.scope_cp))
  {
    this_binding = ECMA_VALUE_UNINITIALIZED;
  }

  ecma_op_create_environment_record (scope_p, this_binding, shared_args_p->header.function_object_p);

#if JERRY_BUILTIN_REALMS
  ecma_global_object_t *saved_global_object_p = JERRY_CONTEXT (global_object_p);
  JERRY_CONTEXT (global_object_p) = ecma_op_function_get_realm (shared_args_p->header.bytecode_header_p);
#endif /* JERRY_BUILTIN_REALMS */

  ret_value = vm_run (&shared_args_p->header, this_binding, scope_p);

#if JERRY_BUILTIN_REALMS
  JERRY_CONTEXT (global_object_p) = saved_global_object_p;
#endif /* JERRY_BUILTIN_REALMS */

  /* ECMAScript v6, 9.2.2.13 */
  if (JERRY_UNLIKELY (this_binding == ECMA_VALUE_UNINITIALIZED))
  {
    if (!ECMA_IS_VALUE_ERROR (ret_value) && !ecma_is_value_object (ret_value))
    {
      if (!ecma_is_value_undefined (ret_value))
      {
        ecma_free_value (ret_value);
        ret_value = ecma_raise_type_error (ECMA_ERR_DERIVED_CTOR_RETURN_NOR_OBJECT_OR_UNDEFINED);
      }
      else
      {
        ret_value = ecma_op_get_this_binding (scope_p);
      }
    }
  }

exit:
  if (JERRY_UNLIKELY (shared_args_p->header.status_flags & VM_FRAME_CTX_SHARED_FREE_LOCAL_ENV))
  {
    ecma_deref_object (scope_p);
  }

  return ret_value;
} /* ecma_op_function_call_constructor */
